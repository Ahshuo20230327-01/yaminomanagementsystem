import tkinter as tk
from tkinter import messagebox
import random
import ctypes

# --- ç¾ä»£åŒ–é…è‰²æ–¹æ¡ˆ (Dark/Flat) ---
C_BG = "#121212"           # èƒŒæ™¯æ¥µé»‘
C_CARD_BG = "#1e1e1e"      # å¡ç‰‡é è¨­é»‘
C_CARD_HOVER = "#2a2a2a"   # å¡ç‰‡æ»‘é
C_CARD_ACTIVE = "#2d2d2d"  # å¡ç‰‡é¸ä¸­èƒŒæ™¯
C_GOLD = "#d4b57e"         # FF14 é‡‘è‰²
C_TEXT_MAIN = "#ececec"    # ä¸»è¦æ–‡å­—
C_TEXT_DIM = "#666666"     # æ¬¡è¦æ–‡å­—
C_ACCENT = "#d4b57e"       # å¼·èª¿è‰²

# è·èƒ½è‰²ç¥¨ (æ‰å¹³åŒ–)
C_TANK = "#3d5c8a"         # æš—è—
C_TANK_HL = "#669df6"      # äº®è— (é¸ä¸­)
C_HEAL = "#3d7042"         # æš—ç¶ 
C_HEAL_HL = "#81c995"      # äº®ç¶  (é¸ä¸­)
C_DPS = "#8a3d3d"          # æš—ç´…
C_DPS_HL = "#f28b82"       # äº®ç´… (é¸ä¸­)

# å›ºå®šåå–®
PRESET_NAMES = [
    "è‰²ç´ ", "rå†·", "æ˜¥æ²", "å¸Œå¦®", "Evas", 
    "äºå­é†¬", "å¹¼ç¨šåœ’ã®Crow", "å®…K", "é˜¿è‰", "é¢¨æ„‰", 
    "çª©ç¦", "NANA"
]

class TeamMakerApp:
    def __init__(self, root):
        self.root = root
        self.root.title("FF14 ä»»å‹™æœå°‹å™¨ (Modern UI)")
        self.root.configure(bg=C_BG)
        
        # è¨­å®šè¦–çª—å¤§å°èˆ‡ç½®ä¸­
        # é«˜åº¦ç¶­æŒ 920 ä»¥ç¢ºä¿ä¸è¢«é®æ“‹
        w, h = 1200, 920
        ws, hs = root.winfo_screenwidth(), root.winfo_screenheight()
        x, y = int(ws/2 - w/2), int(hs/2 - h/2)
        self.root.geometry(f'{w}x{h}+{x}+{y}')

        # è³‡æ–™çµæ§‹åˆå§‹åŒ–
        self.roster_data = []
        for name in PRESET_NAMES:
            self.roster_data.append({
                "type": "preset",
                "name": name,
                "role": "D",
                "selected": False,
                "widgets": {} 
            })
        
        # åŠ å…¥ 2 å€‹æ‰‹å‹•æ¬„ä½
        for i in range(2):
            self.roster_data.append({
                "type": "manual",
                "name": "",
                "role": "D",
                "selected": False,
                "widgets": {}
            })

        self.setup_ui()

    def setup_ui(self):
        # --- æ¨™é¡Œå€ ---
        header = tk.Frame(self.root, bg=C_BG)
        header.pack(fill="x", pady=(20, 10))
        
        # [ä¿®æ”¹] æ¨™é¡Œä¸­æ–‡åŒ–
        tk.Label(header, text="ä»»å‹™æœå°‹å™¨", font=("å¾®è»Ÿæ­£é»‘é«”", 28, "bold"), bg=C_BG, fg=C_GOLD).pack()
        tk.Label(header, text="ç™¾è¬äºç±³è«¾æ—…åœ˜ åˆ†çµ„ç³»çµ±", font=("å¾®è»Ÿæ­£é»‘é«”", 12), bg=C_BG, fg=C_TEXT_DIM).pack()
        
        # é‡‘è‰²åˆ†éš”ç·š
        tk.Frame(self.root, bg=C_GOLD, height=2).pack(fill="x", padx=40, pady=(0, 20))

        # --- é›™æ¬„ä½ˆå±€ ---
        container = tk.Frame(self.root, bg=C_BG)
        container.pack(fill="both", expand=True, padx=40, pady=10)

        # å·¦æ¬„ï¼šåå–®å€
        self.left_frame = tk.Frame(container, bg=C_BG)
        self.left_frame.pack(side=tk.LEFT, fill="both", expand=True, padx=(0, 20))

        # å³æ¬„ï¼šæ§åˆ¶èˆ‡çµæœ
        self.right_frame = tk.Frame(container, bg=C_BG)
        self.right_frame.pack(side=tk.RIGHT, fill="both", expand=True)

        # --- ç¹ªè£½å·¦æ¬„å…§å®¹ ---
        # [ä¿®æ”¹] æ¨™ç±¤ä¸­æ–‡åŒ–
        tk.Label(self.left_frame, text="å†’éšªè€…åå–®", font=("å¾®è»Ÿæ­£é»‘é«”", 14, "bold"), bg=C_BG, fg=C_TEXT_DIM).pack(anchor="w", pady=(0, 10))
        
        # ç”Ÿæˆæ¯ä¸€åˆ— (å¡ç‰‡)
        for idx, data in enumerate(self.roster_data):
            self.create_player_card(self.left_frame, idx, data)
            
            # åœ¨å›ºå®šåå–®å’Œæ‰‹å‹•åå–®ä¸­é–“åŠ å€‹åˆ†éš”
            if idx == len(PRESET_NAMES) - 1:
                tk.Frame(self.left_frame, bg="#333", height=1).pack(fill="x", pady=15)
                # [ä¿®æ”¹] æ¨™ç±¤ä¸­æ–‡åŒ–
                tk.Label(self.left_frame, text="å¤–æ‰¾æ”¯æ´", font=("å¾®è»Ÿæ­£é»‘é«”", 12, "bold"), bg=C_BG, fg=C_TEXT_DIM).pack(anchor="w", pady=(0, 5))

        # --- ç¹ªè£½å³æ¬„å…§å®¹ ---
        # æ§åˆ¶å€å¡Š
        ctrl_box = tk.Frame(self.right_frame, bg=C_CARD_BG, padx=20, pady=20)
        ctrl_box.pack(fill="x", pady=(0, 20))
        
        # [ä¿®æ”¹] æ¨™ç±¤ä¸­æ–‡åŒ–
        tk.Label(ctrl_box, text="éšŠä¼æ•¸é‡", font=("å¾®è»Ÿæ­£é»‘é«”", 12, "bold"), bg=C_CARD_BG, fg=C_GOLD).pack(anchor="w")
        
        input_row = tk.Frame(ctrl_box, bg=C_CARD_BG)
        input_row.pack(fill="x", pady=10)
        
        self.entry_team_count = tk.Entry(input_row, width=5, font=("Arial", 18), bg="#111", fg=C_GOLD, relief="flat", insertbackground=C_GOLD, justify="center")
        self.entry_team_count.insert(0, "2")
        self.entry_team_count.pack(side=tk.LEFT)
        
        # [ä¿®æ”¹] æŒ‰éˆ•ä¸­æ–‡åŒ–
        btn_run = tk.Button(input_row, text="é–‹å§‹ä»»å‹™åˆ†é…", command=self.generate_teams,
                            bg=C_GOLD, fg="#000", font=("å¾®è»Ÿæ­£é»‘é«”", 14, "bold"), relief="flat", padx=20, pady=5, cursor="hand2")
        btn_run.pack(side=tk.RIGHT)
        
        # çµæœé¡¯ç¤ºå€
        # [ä¿®æ”¹] å­—é«”å¾ 13 åŠ å¤§åˆ° 16ï¼Œæ”¹ç”¨å¾®è»Ÿæ­£é»‘é«”ä»¥é…åˆä¸­æ–‡
        self.text_result = tk.Text(self.right_frame, bg="#0a0a0a", fg=C_TEXT_MAIN, font=("å¾®è»Ÿæ­£é»‘é«”", 16), relief="flat", padx=15, pady=15)
        self.text_result.pack(fill="both", expand=True)
        
        # è¨­å®šæ–‡å­—é¡è‰²æ¨™ç±¤
        self.text_result.tag_config("tank", foreground=C_TANK_HL)
        self.text_result.tag_config("healer", foreground=C_HEAL_HL)
        self.text_result.tag_config("dps", foreground=C_DPS_HL)
        self.text_result.tag_config("gold", foreground=C_GOLD, font=("å¾®è»Ÿæ­£é»‘é«”", 16, "bold"))
        self.text_result.tag_config("dim", foreground=C_TEXT_DIM)

    def create_player_card(self, parent, idx, data):
        # å¡ç‰‡å®¹å™¨
        card = tk.Frame(parent, bg=C_CARD_BG, padx=10, pady=8)
        card.pack(fill="x", pady=2)
        
        # ä¿å­˜ widget å¼•ç”¨
        data['widgets']['card'] = card

        # å·¦å´ï¼šåå­— (é»æ“Šåˆ‡æ›é¸å–)
        if data['type'] == 'preset':
            name_lbl = tk.Label(card, text=data['name'], font=("å¾®è»Ÿæ­£é»‘é«”", 12), bg=C_CARD_BG, fg=C_TEXT_DIM, width=15, anchor="w", cursor="hand2")
            name_lbl.pack(side=tk.LEFT, padx=5)
            name_lbl.bind("<Button-1>", lambda e, i=idx: self.toggle_select(i))
            data['widgets']['name_lbl'] = name_lbl
        else:
            # æ‰‹å‹•è¼¸å…¥æ¡†
            name_entry = tk.Entry(card, font=("å¾®è»Ÿæ­£é»‘é«”", 11), bg="#333", fg=C_TEXT_MAIN, relief="flat", width=15, insertbackground=C_TEXT_MAIN)
            name_entry.pack(side=tk.LEFT, padx=5, ipady=3)
            name_entry.bind("<KeyRelease>", lambda e, i=idx: self.on_manual_input(i, name_entry.get()))
            data['widgets']['name_entry'] = name_entry

        # å³å´ï¼šè·èƒ½é¸æ“‡å™¨ (T/H/D)
        role_frame = tk.Frame(card, bg=C_CARD_BG)
        role_frame.pack(side=tk.RIGHT)
        
        # å»ºç«‹ä¸‰å€‹è·èƒ½æŒ‰éˆ•
        for r_code in ["T", "H", "D"]:
            # ä½¿ç”¨ Label æ¨¡æ“¬æŒ‰éˆ•ï¼Œé¿å…åŸç”Ÿ Radiobutton æ¨£å¼
            lbl = tk.Label(role_frame, text=r_code, font=("Arial", 10, "bold"), 
                           bg=C_CARD_BG, fg=C_TEXT_DIM, width=4, pady=2, cursor="hand2")
            lbl.pack(side=tk.LEFT, padx=2)
            # ä½¿ç”¨é–‰åŒ…ç¶å®šåƒæ•¸
            lbl.bind("<Button-1>", lambda e, i=idx, r=r_code: self.set_role(i, r))
            data['widgets'][f'btn_{r_code}'] = lbl

        # ç¶å®š Hover æ•ˆæœ
        card.bind("<Enter>", lambda e: self.on_hover(card, True))
        card.bind("<Leave>", lambda e: self.on_hover(card, False))
        
        self.update_row_visual(idx)

    # --- äº’å‹•é‚è¼¯ ---

    def on_hover(self, widget, is_hover):
        pass 

    def toggle_select(self, idx):
        self.roster_data[idx]['selected'] = not self.roster_data[idx]['selected']
        self.update_row_visual(idx)

    def set_role(self, idx, role):
        self.roster_data[idx]['role'] = role
        # æ‰‹å‹•è¼¸å…¥ä¸”åå­—ç‚ºç©ºæ™‚ï¼Œä¸è‡ªå‹•é¸å–
        if self.roster_data[idx]['type'] == 'manual' and not self.roster_data[idx]['name']:
            pass
        else:
            self.roster_data[idx]['selected'] = True
        self.update_row_visual(idx)

    def on_manual_input(self, idx, value):
        self.roster_data[idx]['name'] = value.strip()
        if value.strip():
            self.roster_data[idx]['selected'] = True
        else:
            self.roster_data[idx]['selected'] = False
        self.update_row_visual(idx)

    def update_row_visual(self, idx):
        data = self.roster_data[idx]
        ws = data['widgets']
        
        # 1. æ›´æ–°å¡ç‰‡èƒŒæ™¯
        if data['selected']:
            ws['card'].config(bg=C_CARD_ACTIVE)
            if 'name_lbl' in ws: ws['name_lbl'].config(bg=C_CARD_ACTIVE, fg=C_GOLD, font=("å¾®è»Ÿæ­£é»‘é«”", 12, "bold"))
        else:
            ws['card'].config(bg=C_CARD_BG)
            if 'name_lbl' in ws: ws['name_lbl'].config(bg=C_CARD_BG, fg=C_TEXT_DIM, font=("å¾®è»Ÿæ­£é»‘é«”", 12))

        # 2. æ›´æ–°è·èƒ½æŒ‰éˆ•
        # é‡ç½®èƒŒæ™¯
        for r in ["T", "H", "D"]:
            bg_color = C_CARD_BG if not data['selected'] else C_CARD_ACTIVE
            ws[f'btn_{r}'].config(bg=bg_color, fg=C_TEXT_DIM, relief="flat")
        
        # é«˜äº®ç•¶å‰è·èƒ½
        curr = data['role']
        if data['selected']:
            if curr == 'T': ws['btn_T'].config(bg=C_TANK, fg="white")
            if curr == 'H': ws['btn_H'].config(bg=C_HEAL, fg="white")
            if curr == 'D': ws['btn_D'].config(bg=C_DPS, fg="white")
        else:
            # æœªé¸å–æ™‚é¡¯ç¤ºå¾®å¼±é¡è‰²
            if curr == 'T': ws['btn_T'].config(fg=C_TANK)
            if curr == 'H': ws['btn_H'].config(fg=C_HEAL)
            if curr == 'D': ws['btn_D'].config(fg=C_DPS)

    # --- æ ¸å¿ƒé‚è¼¯ ---
    def append_colored_text(self, text, tag="dim"):
        self.text_result.insert(tk.END, text, tag)

    def generate_teams(self):
        try:
            num_teams = int(self.entry_team_count.get())
        except ValueError:
            messagebox.showerror("éŒ¯èª¤", "è«‹è¼¸å…¥æ•¸å­—")
            return

        tanks, healers, dps = [], [], []

        for data in self.roster_data:
            if data['selected'] and data['name']:
                # è™•ç†æ‰‹å‹•è¼¸å…¥åå­—
                final_name = data['name']
                if data['type'] == 'manual':
                    final_name += "(æ‰‹)"
                
                if data['role'] == 'T': tanks.append(final_name)
                elif data['role'] == 'H': healers.append(final_name)
                else: dps.append(final_name)

        if not (tanks or healers or dps):
            messagebox.showwarning("æç¤º", "è«‹è‡³å°‘é¸æ“‡ä¸€åæˆå“¡")
            return

        random.shuffle(tanks)
        random.shuffle(healers)
        random.shuffle(dps)

        self.text_result.config(state=tk.NORMAL)
        self.text_result.delete("1.0", tk.END)

        for i in range(num_teams):
            t = tanks.pop(0) if tanks else "(ç¼ºå“¡)"
            h = healers.pop(0) if healers else "(ç¼ºå“¡)"
            d1 = dps.pop(0) if dps else "(ç¼ºå“¡)"
            d2 = dps.pop(0) if dps else "(ç¼ºå“¡)"

            # [ä¿®æ”¹] è¼¸å‡ºæ–‡å­—ä¸­æ–‡åŒ–
            self.append_colored_text(f"ç¬¬ {i+1} å°éšŠ\n", "gold")
            self.append_colored_text(f"ğŸ›¡ï¸ {t}\n", "tank" if t != "(ç¼ºå“¡)" else "dim")
            self.append_colored_text(f"ğŸ’š {h}\n", "healer" if h != "(ç¼ºå“¡)" else "dim")
            self.append_colored_text(f"âš”ï¸ {d1}, {d2}\n", "dps" if d1 != "(ç¼ºå“¡)" else "dim")
            self.append_colored_text("\n")

        if tanks or healers or dps:
            self.append_colored_text("-" * 30 + "\n", "dim")
            # [ä¿®æ”¹] è¼¸å‡ºæ–‡å­—ä¸­æ–‡åŒ–
            self.append_colored_text("å€™è£œåå–®\n", "gold")
            if tanks: self.append_colored_text(f"å¦: {', '.join(tanks)}\n", "tank")
            if healers: self.append_colored_text(f"è£œ: {', '.join(healers)}\n", "healer")
            if dps: self.append_colored_text(f"DPS: {', '.join(dps)}\n", "dps")

        self.text_result.config(state=tk.DISABLED)

if __name__ == "__main__":
    try:
        ctypes.windll.shcore.SetProcessDpiAwareness(1)
    except:
        pass
    root = tk.Tk()
    app = TeamMakerApp(root)
    root.mainloop()
